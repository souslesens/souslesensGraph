<style>

    #graphoramaAccordion {

    / / font-size: 12 px;
    }


</style>

<script>

    var graphorama = (function () {
        var self = {};
        self.currentGraphorama = [];
        self.graphoramaLocalKeys = [];
        self.storageMode = "neo4j";
        self.user = "admin";
        var treeData = [];

        var localStorageKeys = "souslesensGraphoramaKeys"
        var localStoragePrefix = "souslesensGraphorama"


        self.init = function () {

            graphorama.loadAllRecordings();


        }


        self.startRecording = function () {
            if (self.currentGraphorama.length > 0) {
                return self.stopRecording();
            } else
                self.currentGraphorama = [];
            $("#graphoramaAccordion").accordion("option", "active", 1);
        }


        self.createGraphorama = function () {

            var name = prompt("Graphorama name ")
            if (!name || name == "") {
                return;
            }
            else {
                var date = new Date();


                self.currentGraphorama = {
                    name: name,
                    data: self.currentGraphorama,
                    date: date
                }

                var cypher = 'MERGE (n:visjsGraphorama { subGraph:"users",name:"' + name + '",user:"' + self.user + '",date:"' + date + '" }) RETURN ID(n) as id;'
                toutlesensData.executeCypher(cypher, function (err, result) {
                    if (err)
                        console.log(err);


                    var x = result;
                    debugger
                    $('#treeDivGraphorama').jstree(true).create_node("#", {text: name, id: result[0].id});

                })
            }

        }

        // ,data:"' + btoa(JSON.stringify(self.currentGraphorama)) + '


        self.addGraph = function () {
            var name = prompt("enter graph title")
            if (!name || name == "")
                return;
            var date = new Date();
            var graphoramaId=$('#treeDivGraphorama').jstree(true).get_selected()[0];
            debugger
            var graphData = visjsGraph.graphHistory[visjsGraph.graphHistory.currentIndex];
            graphData = btoa(JSON.stringify(graphData));
            var cypher="match(m:visjsGraphorama) where ID(m)="+graphoramaId +
                " MERGE (n:visjsGraph  { subGraph:'users',name:'" + name + "',user:'" + self.user + "',date:'" + date + "',data:'" + graphData + "' }) " +
                "create (n)-[r:inGraphorama]->(m) return ID(n) as id"

            console.log(cypher)
            toutlesensData.executeCypher(cypher, function (err, result) {
                if (err)
                    console.log(err);
                $('#treeDivGraphorama').jstree(true).create_node(graphoramaId, {text: name, id: result[0].id});


            })

        }


        self.deleteGraphorama = function (id) {
            if (confirm("delete Graphorama  and all its slides ")) {
                toutlesensData.executeCypher("MATCH (n:visjsGraph) where ID(n)=" + id + " delete n", function (err, result) {
                    debugger

                    var ref = $('#treeDivGraphorama').jstree(true),
                        sel = ref.get_selected();
                    if (!sel.length) {
                        return false;
                    }
                    ref.delete_node(sel);

                })
            }
        }
        self.deleteSlide = function (parentId, id) {

        }


        self.loadAllRecordings = function () {
            if (self.storageMode == "local") {
                var keys = localStorage.getItem(localStorageKeys);
                keys = JSON.parse(keys);
                common.fillSelectOptionsWithStringArray(graphorama_recordSelect, keys)
            }
            else if (self.storageMode == "neo4j") {
                toutlesensData.executeCypher("MATCH (n:visjsGraph) where n.subGraph='users' and n.user='" + self.user + "' return  n", function (err, result) {
                    // common.fillSelectOptions(graphorama_recordSelect, result, "name", "name")
                    treeData = []
                    result.forEach(function (line) {
                        treeData.push({text: line.n.properties.name, id: line.n._id, children: []})
                    })

                    var plugins = [];
                    plugins.push("sort");
                    plugins.push("types");
                    plugins.push("contextmenu");
                    plugins.push("dnd");


                    $('#treeDivGraphorama').jstree({
                        'core': {
                            'check_callback': true,
                            'data': treeData,


                        }
                        , 'contextmenu': {
                            'items': graphorama.treeMenu
                        },
                        'plugins': plugins,
                    }).on("select_node.jstree",
                        function (evt, obj) {
                            graphorama.onNodeSelect(obj.node);
                        })

                })

            }

        }

        self.treeMenu = function (node) {

            var items = {}


            var menuItemData = {}
            menuItemData.id = node.id,
                menuItemData.parentId = node.parent;
            menuItemData.parents = node.parents;


            items ["delete"] = {
                label: "delete",
                data: menuItemData,
                action: (function (menuItem) {
                    if (menuItemData.parentId == "#") {//graphorama
                        self.deleteGraphorama(menuItemData.id)

                    } else {//slide
                        self.deleteSlide(menuItemData.parentId, menuItemData.id)
                    }

                })

            };
            return items;

        }
        self.onNodeSelect = function (obj) {
            if (obj.parent == "#") { // graphorama
                if (obj.children.length == 0) {
                    graphorama.loadGraphorama(obj.id, function (err, children) {
                        if (err)
                            return console.log(err);
                        var position = 'last';
                        var parent = $('#treeDivGraphorama').jstree('get_selected');
                        children.forEach(function (child) {
                                var childNode = {
                                    parent: obj.id,
                                    text: child.title,
                                    id: child.title,
                                    data: child.data,
                                    children: []
                                }
                                $('#treeDivGraphorama').jstree('create_node', obj.id, childNode, 'last', function (www) {
                                    $('#treeDivGraphorama').jstree('open_node', parent);
                                });
                            }
                        )
                    })
                }
            }
            else {//slide
                var data = obj.data;
                self.playSlide(data);
            }

        }

        self.loadGraphorama = function (graphoramaId, callback) {

            if (self.storageMode == "neo4j") {
                toutlesensData.executeCypher("MATCH (n:visjsGraph) where ID(n)=" + graphoramaId + " return n", function (err, result) {
                    if (err)
                        return callback(err)
                    var graphorama = (result[0].n.properties)
                    graphorama.data = JSON.parse(atob(graphorama.data))//base64 to str
                    self.currentGraphorama = graphorama;
                    return callback(null, self.currentGraphorama.data)

                })

            }

        }
        self.playSlide = function (slide) {

            //  var index = $("#graphorama_slidesSelect").prop('selectedIndex')
            visjsGraph.importGraph(slide.graph)

            var context = slide.context;
            var html = "<ul>";

            for (var key in context) {
                html += "<li>" + key + ":"
                context[key].forEach(function (value, index) {
                    if (index > 0)
                        html += ",";
                    html += value;
                })
                html += "</li>"


            }
            $("#graphorama_slideContentDiv").html(html)
            if (slide.comment)
                $("#graphorama_slideCommentTA").html(slide.comment)

        }


        self.updateSlide = function () {

        }


        return self;

    })()


</script>

<button onclick="graphorama.createGraphorama()"> new Graphorama</button>
<button onclick="graphorama.addGraph()"> add current Graph</button>
<div id="treeDivGraphorama" style="width:400px;height: 400px;overflow: auto"></div>


comment <textarea id="graphorama_graphoramaCommentTA" cols="50" rows="5">
    </textarea>


context
<div id="graphorama_slideContentDiv"></div>
comment
<textarea id="graphorama_slideCommentTA" cols="50" rows="5">

</textarea>
<button onclick="self.updateSlide()">update Slide</button>
</textarea>
<button onclick="self.deleteSlide()">Delete Slide</button>

<div id="graphorama_currentGraphoramasDiv">
    <table>
        <tr>
            <td>
                <button onclick="graphorama.addGraph()">add Graph</button>
            </td>
            <td>
                <button onclick="graphorama.stopRecording()">stopRecording</button>
            </td>


        </tr>
    </table>


    <br>

</div>

