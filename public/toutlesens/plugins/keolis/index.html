<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <script src="../../../common/js/jquery/jquery.min.js"></script>
    <script src="../../../common/js/jquery/jquery-ui.min.js"></script>
    <script src="../../../common/js/jquery/jquery.splitter.js"></script>

    <script src="../../../common/js/jsTree/jstree.min.js"></script>
    <script src="../../../common/js/jsTreeController.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css"/>
    <script>

        $(function () {
            $("#treeDivKeolis").width(rightPanelWidth - 40).height(totalHeight - 150).css("visibility", "visible")
        })
        var keolis = (function () {


            var self = {};
            var data = {};
            var type;
           self.selection = []
            self.loadJon = function (_type) {
                type=_type
                //   $("#treeDivKeolis").html("");
                var file
                if (type == 'tags')
                    file = "tagsFR.csv.json"
                else if (type == 'categories')
                    file = 'categoriesFR.csv.json'



                
                function customMenu(node) {
                    var items = {
                        'item1': {
                            'label': 'item1',
                            'action': function () {
                                alert(1)
                            }
                        },
                        'item2': {
                            'label': 'item2',
                            'action': function () {
                                alert(2)
                            }
                        }
                    }


                    return items;
                }


                $.ajax({
                    type: "GET",
                    url: "/toutlesens/plugins/keolis/" + file,
                    dataType: "json",
                    success: function (_data, textStatus, jqXHR) {
                        data = _data.data;
                        var x = data
                        var jsTreeData = []
                        data.forEach(function (line, index) {
                            var ok = false;
                            var parent;
                            if (type == "tags" && line.parent == "Tags") {
                                ok = true;
                                parent = (line.parent == "Tags") ? "#" : line.parentID;
                            }
                            if (type == "categories" && line.parent == "Communautés") {
                                ok = true;
                                parent = (line.parent == "Communautés") ? "#" : line.parentID;

                            }
                            if (ok) {
                                jsTreeData.push({
                                    id: line.iD,
                                    parent: parent,
                                    text: line.nom
                                })
                            }
                        })
                        jsTreeData.sort(function (a, b) {
                            if (a.text > b.text)
                                return 1;
                            if (a.text < b.text)
                                return -1;
                            return 0;

                        })
                        //console.log(JSON.stringify(jsTreeData,null,2))
                        var plugins = [];
                        plugins.push("search");
                        plugins.push("sort");
                        plugins.push("types");
                        plugins.push("contextmenu")

                        $('#treeDivKeolis').jstree({
                            'core': {
                                'check_callback': true,
                                'data': jsTreeData,


                            }
                            , 'contextmenu': {
                                'items': keolis.treeMenu
                            },
                            'plugins': plugins,
                        }).on("select_node.jstree",
                            function (evt, obj) {
                                self.onNodeSelect(obj.node);
                            })


                    },
                    error: function (xhr, err, msg) {
                        $("#message").css("color", "red");
                        $("#message").html(err);
                        console.log(xhr);
                        console.log(err);
                        console.log(msg);
                    }
                });
            }

            self.getChildren = function (id) {
                var children = [];
                data.forEach(function (line) {
                    if (line.parentID == id)
                        children.push({
                            id: line.iD,
                            //  parent: id,
                            text: line.nom
                        })
                })
                return children;

            }

            self.addChildrenNodes = function (obj) {

                var position = 'last';
                var parent = $('#treeDivKeolis').jstree('get_selected');
                var children = self.getChildren(obj.id)
                children.forEach(function (childNode) {
                    $('#treeDivKeolis').jstree('create_node', obj.id, childNode, 'last', function (www) {
                        $('#treeDivKeolis').jstree('open_node', parent);
                    });

                })
            }


            self.onNodeSelect = function (obj) {
                if (obj.children.length == 0)
                    self.addChildrenNodes(obj);
            }

            self.treeMenu = function (node) {
                var items = {}


                var menuItemData = {}
                menuItemData.parentId = node.parent;
                menuItemData.parents = node.parents;

                items ["selectNode"] = {
                    label: "selectNode",
                    data: menuItemData,
                    action: (function (menuItem) {
                        keolis.selection.push(node.id)
                    })

                }
                items ["selectNodeAndChildren"] = {
                    label: "selectNodeAndChildren",
                    data: menuItemData,
                    action: (function (menuItem) {
                        keolis.selection.push(node.id)
                        node.children.forEach(function(child){
                            keolis.selection.push(child)
                        })
                    })

                }
                items ["clearSelection"] = {
                    label: "clearSelection",
                    data: menuItemData,
                    action: (function (menuItem) {
                        keolis.selection=[];
                    })

                }
                return items;
            }

            self.graphSelection = function () {
                var sel=self.selection;
               advancedSearch.addClauseByIdsArray("id",self.selection,type)

            }



            return self;
        })()
    </script>

</head>
<body>
<button onclick="  keolis.loadJon('tags')">tags</button>
<button onclick="  keolis.loadJon('categories')">categories</button>
<br>
<div id="treeDivKeolis" style="width:400px;height: 800px;overflow: auto"></div>
<button onclick="keolis.graphSelection()">graphSelection</button>
<script>

</script>

</body>
</html>