<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <!--  <script src="../../../common/js/jquery/jquery.min.js"></script>
      <script src="../../../common/js/jquery/jquery-ui.min.js"></script>-->
    <script src="../../../common/js/jquery/jquery.splitter.js"></script>

    <script src="../../../common/js/jsTree/jstree.min.js"></script>
    <script src="../../../common/js/jsTreeController.js"></script>
    <script src="../../../common/js/cypher.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css"/>
    <script>

        $(function () {
            $("#graphSelectionButton").css("display", "none")
            $("#treeDivKeolis").width(rightPanelWidth - 40).height(totalHeight - 150).css("visibility", "visible")
        })
        var quantum = (function () {


            var self = {};
            var data = {};
            var type;
            self.selection = [];
            self.selectionName = "";
            self.currentNode;
            self.initiated = false;


            self.getNodes = function (type, rootNeoId, callback) {
                var payload = {
                    generateTreeFromChildToParentRelType: 1,
                    label: "physicalClass",
                    relType: "childOf",
                    rootNeoId: rootNeoId
                }


                $.ajax({
                    type: "POST",
                    url: "../../neo",
                    dataType: "json",
                    data: payload,
                    success: function (data, textStatus, jqXHR) {
                        return callback(null, data)
                    },
                    error: function (error) {
                        return callback(error)
                    }
                })
            }


            self.loadJon = function (_type) {
                $("#graphSelectionButton").css("display", "none")
                type = _type
                if (type == 'physicalClass') {
                    file = "tagsFR.csv.json"
                    context.queryObject.label = "tag";
                }
                else if (type == 'functionalClass') {
                    file = 'categoriesFR.csv.json';
                    context.queryObject.label = "categorieCommunaute";
                }

                function customMenu(node) {
                    var items = {
                        'item1': {
                            'label': 'item1',
                            'action': function () {
                                alert(1)
                            }
                        },
                        'item2': {
                            'label': 'item2',
                            'action': function () {
                                alert(2)
                            }
                        }
                    }


                    return items;
                }


                self.getNodes(type, 24789, function (err, data) {
                    var jsTreeData = []
                    data.forEach(function (line, index) {
                        jsTreeData.push(line)
                    })
                    jsTreeData.sort(function (a, b) {
                        if (a.text > b.text)
                            return 1;
                        if (a.text < b.text)
                            return -1;
                        return 0;

                    })


                    if (self.initiated) {
                        $('#treeDivKeolis').jstree(true).settings.core.data = jsTreeData;
                        $('#treeDivKeolis').jstree(true).refresh();
                        return;
                    }

                    self.initiated = true;
                    //console.log(JSON.stringify(jsTreeData,null,2))
                    var plugins = [];
                    plugins.push("search");
                    plugins.push("sort");
                    plugins.push("types");
                    plugins.push("contextmenu");


                    $('#treeDivKeolis').jstree({
                        'core': {
                            'check_callback': true,
                            'data': jsTreeData,


                        }
                        , 'contextmenu': {
                            'items': keolis.treeMenu
                        },
                        'plugins': plugins,
                    }).on("select_node.jstree",
                        function (evt, obj) {
                            self.onNodeSelect(obj.node);
                        })


                });

            }

            self.getChildren = function (id) {
                var children = [];
                data.forEach(function (line) {
                    if (line.parentID == id)
                        children.push({
                            id: line.iD,
                            //  parent: id,
                            text: line.nom
                        })
                })
                return children;

            }

            self.addChildrenNodes = function (obj) {
                debugger
                var position = 'last';
                var parent = $('#treeDivKeolis').jstree('get_selected');
                var parentId = obj.id;
                self.getNodes(type, obj.id, function (err, data) {
                    data.forEach(function (childNode, index) {
                        childNode.id = "" + childNode.id
                        if (childNode.id != parentId) {

                            childNode.parent = "" + parent[0];

                         console.log(JSON.stringify(childNode))
                            try {
                                $('#treeDivKeolis').jstree('create_node', childNode.parent, childNode, 'last', function (www) {
                                    //
                                });
                            }

                            catch (e) {
                                var xx = 3
                            }
                        }
                        //  $('#treeDivKeolis').jstree('open_node', parent);

                else
                    {
                        var xx = 1;
                    }

                })
            }
        );
        }


        self.onNodeSelect = function (obj) {

            if (obj.children.length == 0)
                self.addChildrenNodes(obj);
        }

        self.treeMenu = function (node) {
            var items = {}


            var menuItemData = {}
            menuItemData.parentId = node.parent;
            menuItemData.parents = node.parents;
            menuItemData.text = node.text
            self.currentNode = node;
            $("#graphSelectionButton").css("display", "block")
            items ["selectNode"] = {
                label: "selectNode",
                data: menuItemData,
                action: (function (menuItem) {

                    keolis.selection.push(node.id)
                    $("#" + node.id + "_anchor").css("color", "blue");
                    self.selectionName = "[" + type + "] " + menuItemData.text
                })

            }
            items ["selectNodeAndChildren"] = {
                label: "selectNodeAndChildren",
                data: menuItemData,
                action: (function (menuItem) {
                    $(".jstree-anchor").css("color", "black");
                    keolis.selection = [];
                    $("#graphSelectionButton").css("display", "block")
                    self.currentNode += " and children"
                    keolis.selection.push(node.id)
                    $("#" + node.id + "_anchor").css("color", "blue");
                    self.selectionName = "[" + type + "]  and children " + menuItemData.text
                    node.children.forEach(function (child) {
                        keolis.selection.push(child)
                        $("#" + child + "_anchor").css("color", "blue");
                    })
                })

            }
            items ["addNodeAndChildrenToSelection"] = {
                label: "addNodeAndChildrenToSelection",
                data: menuItemData,
                action: (function (menuItem) {
                    self.currentNode += " and children"
                    keolis.selection.push(node.id)
                    $("#graphSelectionButton").css("display", "block")
                    $("#" + node.id + "_anchor").css("color", "blue");
                    if (self.selectionName.length > 0)
                        self.selectionName += " , "
                    self.selectionName += "[" + type + "]  and children " + menuItemData.text
                    node.children.forEach(function (child) {
                        keolis.selection.push(child)
                        $("#" + child + "_anchor").css("color", "blue");
                    })
                })

            }
            items ["clearSelection"] = {
                label: "clear selection",
                data: menuItemData,
                action: (function (menuItem) {
                    $(".jstree-anchor").css("color", "black");
                    keolis.selection = [];
                    self.selectionName = ""
                    $("#graphSelectionButton").css("display", "none")
                })

            }

            /*   items ["useSelection"] = {
                label: "use selection...",
                data: menuItemData,
                action: (function (menuItem) {
                    self.graphSelection();
                })

            }*/


            return items;
        }

        self.graphSelection = function () {

            var sel = self.selection;
            var label = "";
            if (type == "categories")
                label = "categorieCommunaute"
            else if (type == "tags")
                label = "tag"


            context.queryObject = {};
            var clauseText = self.selectionName;
            context.queryObject.label = label;
            context.queryObject.text = clauseText;
            context.queryObject.type = "nodeSet-plugin-" + label;
            context.queryObject.where = searchNodes.getWhereClauseFromArray("iD", self.selection, "n");
            var cypher = "MATCH (n:" + label + ") where " + context.queryObject.where + " RETURN collect(ID(n)) as ids ";

            Cypher.executeCypher(cypher, function (err, result) {
                if (err) {
                    return console.log(err);
                }

                context.queryObject.nodeSetIds = result[0].ids
                $("#findTabs").tabs("option", "active", 0);
                buildPaths.show("only")
            })


        }

        self.clearSelection = function () {
            $(".jstree-anchor").css("color", "black");
            keolis.selection = [];
            $("#graphSelectionButton").css("display", "block")
        }


        return self;
        })
        ()
    </script>

</head>
<body>
<button onclick="  quantum.loadJon('tags')">tags</button>
<button onclick="  quantum.loadJon('categories')">categories</button>
<!--<button onclick="  keolis.clearSelection()">clear selection</button>-->
<button onclick="quantum.graphSelection()" id="graphSelectionButton" display="none">Use selection</button>

<br>
<div id="treeDivKeolis" style="width:400px;height: 800px;overflow: auto"></div>

<script>

</script>

</body>
</html>